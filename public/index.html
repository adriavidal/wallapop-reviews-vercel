<!-- Fragmento simplificado para la parte clave -->
<form id="reviewForm">
  <label>Perfil URL: <input type="url" id="profileUrl" required></label>
  
  <div id="starRating">
    <!-- 5 estrellas clicables -->
    <span data-value="1" class="star">‚òÜ</span>
    <span data-value="2" class="star">‚òÜ</span>
    <span data-value="3" class="star">‚òÜ</span>
    <span data-value="4" class="star">‚òÜ</span>
    <span data-value="5" class="star">‚òÜ</span>
  </div>
  
  <div id="thumbsFeedback">
    <button type="button" id="thumbsUp">üëç</button>
    <button type="button" id="thumbsDown">üëé</button>
  </div>
  
  <label>Comentario (opcional):<br>
    <textarea id="comment"></textarea>
  </label>
  
  <label>Captura de pantalla (opcional):
    <input type="file" id="screenshotInput" accept="image/*">
  </label>
  
  <button type="submit">Enviar Opini√≥n</button>
</form>

<script>
  // Variables para estado
  let selectedStars = 0;
  let feedbackType = null; // "positive" or "negative"

  const stars = document.querySelectorAll('#starRating .star');
  stars.forEach(star => {
    star.addEventListener('click', () => {
      selectedStars = parseInt(star.dataset.value);
      feedbackType = null;  // si escoge estrellas, pulgares se desactivan
      updateStarUI();
    });
  });

  document.getElementById('thumbsUp').addEventListener('click', () => {
    feedbackType = 'positive';
    selectedStars = 0;
    updateStarUI();
  });
  document.getElementById('thumbsDown').addEventListener('click', () => {
    feedbackType = 'negative';
    selectedStars = 0;
    updateStarUI();
  });

  function updateStarUI() {
    stars.forEach(star => {
      const val = parseInt(star.dataset.value);
      star.textContent = (val <= selectedStars) ? '‚òÖ' : '‚òÜ';
    });
    // Destacar botones pulgar
    document.getElementById('thumbsUp').style.opacity = feedbackType === 'positive' ? '1' : '0.5';
    document.getElementById('thumbsDown').style.opacity = feedbackType === 'negative' ? '1' : '0.5';
  }

  // Cloudinary info
  const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dmvmvfnfd/upload';
  const UPLOAD_PRESET = 'wallapop';

  document.getElementById('reviewForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const profileUrl = document.getElementById('profileUrl').value.trim();
    const comment = document.getElementById('comment').value.trim();
    const fileInput = document.getElementById('screenshotInput');
    let screenshotUrl = '';

    if (!profileUrl) {
      alert('Por favor, introduce la URL del perfil.');
      return;
    }

    if (selectedStars === 0 && !feedbackType) {
      alert('Por favor, selecciona una valoraci√≥n (estrellas o pulgar).');
      return;
    }

    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);

      try {
        const res = await fetch(CLOUDINARY_URL, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        screenshotUrl = data.secure_url || '';
      } catch (err) {
        alert('Error subiendo la imagen.');
        return;
      }
    }

    // Construir payload para backend
    const payload = {
      profile_url: profileUrl,
      stars: selectedStars,
      feedback_type: feedbackType,
      comment: comment,
      screenshot_url: screenshotUrl
    };

    // Enviar a API
    try {
      const response = await fetch('/api/reviews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (response.ok) {
        alert('Opini√≥n enviada correctamente. ¬°Gracias!');
        // reset form
        e.target.reset();
        selectedStars = 0;
        feedbackType = null;
        updateStarUI();
      } else {
        const err = await response.json();
        alert('Error enviando opini√≥n: ' + (err.error || 'Desconocido'));
      }
    } catch (error) {
      alert('Error de red al enviar la opini√≥n.');
    }
  });
</script>
